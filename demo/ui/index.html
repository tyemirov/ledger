<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ledger Demo — Wallet Scenarios</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.css"
    />
    <link rel="stylesheet" href="./styles.css" />
    <script
      defer
      src="http://localhost:8080/static/auth-client.js"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      id="mpr-ui-bundle"
      defer
      src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.js"
    ></script>
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
    ></script>
    <script type="module" src="./app.js" defer></script>
  </head>
  <body
    class="theme-light"
    data-demo-palette="default"
    data-api-base-url="http://localhost:9090"
    data-tauth-base-url="http://localhost:8080"
  >
    <mpr-header
      id="auth-header"
      brand-label="Marco Polo Research Lab"
      brand-href="https://mprlab.com/"
      nav-links='[
        { "label": "Ledger README", "href": "https://github.com/tyemirov/ledger#readme" },
        { "label": "Demo guide", "href": "https://github.com/tyemirov/ledger/blob/master/demo/docs/demo.md" },
        { "label": "TAuth usage", "href": "https://github.com/tyemirov/ledger/blob/master/docs/TAuth/usage.md" }
      ]'
      site-id="991677581607-r0dj8q6irjagipali0jpca7nfp8sfj9r.apps.googleusercontent.com"
      base-url="http://localhost:8080"
      data-tauth-base-url="http://localhost:8080"
      login-path="/auth/google"
      logout-path="/auth/logout"
      nonce-path="/auth/nonce"
      settings="true"
      settings-label="Settings"
    ></mpr-header>

    <main x-data="LedgerDemo()" x-init="init()">
      <section class="hero">
        <span class="hero__eyebrow">Ledger demo stack</span>
        <h1 class="hero__title">Spend 5 coins, replenish, and observe history</h1>
        <p class="hero__lede">
          This end-to-end scenario signs in with TAuth, bootstraps your wallet with 20 coins,
          enforces 5-coin transactions, and surfaces ledger entries via the demo API and
          ledgerd. Try a successful spend, an insufficient-funds attempt, and a re-spend after
          buying coins to cover all three LG-106 flows.
        </p>
      </section>

      <section class="card status-grid">
        <div class="status-pill" x-text="statusTitle()">Connecting</div>
        <p class="hero__lede" x-text="statusDetail()">Loading…</p>
        <template x-if="profile">
          <dl class="profile" aria-live="polite">
            <div class="profile__row">
              <dt class="profile__label">Name</dt>
              <dd class="profile__value" x-text="profile.display"></dd>
            </div>
            <div class="profile__row">
              <dt class="profile__label">Email</dt>
              <dd class="profile__value" x-text="profile.email"></dd>
            </div>
            <div class="profile__row">
              <dt class="profile__label">Roles</dt>
              <dd class="profile__value" x-text="profile.roles.length ? profile.roles.join(', ') : 'user'"></dd>
            </div>
            <div class="profile__row">
              <dt class="profile__label">Session expires</dt>
              <dd class="profile__value" x-text="profile.expiresDisplay || 'auto-refresh enabled'"></dd>
            </div>
          </dl>
        </template>
        <template x-if="errorMessage">
          <div class="banner banner--error" x-text="errorMessage"></div>
        </template>
        <div class="cta-row">
          <span class="badge" x-text="config ? config.baseUrl : 'Waiting for TAuth'"></span>
          <button class="button button--ghost" type="button" @click="refreshWallet" :disabled="authState !== 'authenticated'">
            Refresh wallet
          </button>
          <button class="button" type="button" @click="signOut" :disabled="authState !== 'authenticated'">
            Sign out
          </button>
        </div>
      </section>

      <template x-if="banner">
        <div class="banner" :class="`banner--${banner.tone}`">
          <p class="banner__title" x-text="banner.title"></p>
          <p class="banner__detail" x-text="banner.detail"></p>
        </div>
      </template>

      <template x-if="zeroBalanceNotice">
        <div class="banner banner--warning">
          <p class="banner__title" x-text="copy.zeroBalanceTitle"></p>
          <p class="banner__detail" x-text="copy.zeroBalanceDetail"></p>
        </div>
      </template>

      <section class="card-grid">
        <article class="card wallet-card">
          <header class="section-heading">
            <div>
              <p class="eyebrow">Wallet</p>
              <h2>20-coin bootstrap &amp; 5-coin spends</h2>
            </div>
            <span class="badge">TAuth @ <span x-text="config ? config.baseUrl : 'loading…'"></span></span>
          </header>

          <template x-if="wallet">
            <div class="wallet-summary" aria-live="polite">
              <div class="wallet-metric">
                <span>Total coins</span>
                <strong x-text="formattedCoins(wallet.balance.totalCoins)">—</strong>
              </div>
              <div class="wallet-metric">
                <span>Available coins</span>
                <strong x-text="formattedCoins(wallet.balance.availableCoins)">—</strong>
              </div>
            </div>
          </template>
          <template x-if="!wallet">
            <p class="placeholder">Sign in and wait a moment while we bootstrap 20 coins for this account.</p>
          </template>

          <div class="actions">
            <button class="button" type="button" @click="spendWalletCoins" :disabled="!canSpend()">
              <span x-text="copy.spendButtonLabel">Spend 5 coins</span>
              <template x-if="isSpendPending">
                <span aria-hidden="true">…</span>
              </template>
            </button>
            <div class="purchase-panel">
              <label class="purchase-label" for="purchase-amount">Buy coins</label>
              <div class="purchase-options" role="group" aria-label="Coin purchase amounts">
                <template x-for="amount in purchaseOptions" :key="amount">
                  <button
                    type="button"
                    class="purchase-option"
                    :class="{ 'purchase-option--active': amount === purchaseCoins }"
                    @click="selectPurchaseAmount(amount)"
                  >
                    <span x-text="`${amount} coins`"></span>
                  </button>
                </template>
              </div>
              <button
                class="button button--secondary"
                type="button"
                @click="purchaseWalletCoins"
                :disabled="!canPurchase()"
              >
                <span x-text="copy.purchaseButtonLabel">Buy coins</span>
                <template x-if="isPurchasePending">
                  <span aria-hidden="true">…</span>
                </template>
              </button>
              <p class="purchase-hint" x-text="copy.purchaseHint"></p>
            </div>
          </div>
        </article>

        <article class="card ledger-card">
          <header class="section-heading">
            <div>
              <p class="eyebrow">Ledger history</p>
              <h2>Latest 10 entries from ledgerd</h2>
            </div>
          </header>
          <template x-if="wallet && wallet.entries.length">
            <ol class="ledger-list">
              <template x-for="entry in wallet.entries" :key="entry.entryId">
                <li class="ledger-row">
                  <div>
                    <p class="ledger-row__type" x-text="entry.type"></p>
                    <p class="ledger-row__meta">
                      <span x-text="`ID ${entry.entryId}`"></span>
                      <span x-text="formattedTimestamp(entry)"></span>
                    </p>
                  </div>
                  <div class="ledger-row__amount">
                    <strong x-text="formattedCoins(entry.amountCoins)"></strong>
                    <code x-text="formattedMetadata(entry)"></code>
                  </div>
                </li>
              </template>
            </ol>
          </template>
          <template x-if="!wallet || wallet.entries.length === 0">
            <p class="placeholder" x-text="copy.ledgerEmpty"></p>
          </template>
        </article>
      </section>
    </main>

    <mpr-footer
      id="page-footer"
      prefix-text="Ledger demo by Marco Polo Research Lab"
      privacy-link-label="Privacy &amp; Terms"
      privacy-link-href="#privacy"
      links-collection='{
        "style": "drop-up",
        "text": "Explore more demos",
        "links": [
          { "label": "Marco Polo Research Lab", "url": "https://mprlab.com" },
          { "label": "LoopAware", "url": "https://loopaware.mprlab.com" },
          { "label": "Gravity Notes", "url": "https://gravity.mprlab.com" },
          { "label": "Allergy Wheel", "url": "https://allergy.mprlab.com" },
          { "label": "Countdown Calendar", "url": "https://countdown.mprlab.com" }
        ]
      }'
      theme-switcher="square"
      theme-config='{"attribute":"data-demo-theme","targets":["body"],"initialMode":"default-light","modes":[{"value":"default-light","attributeValue":"light","classList":["theme-light"],"dataset":{"data-demo-palette":"default"}},{"value":"sunrise-light","attributeValue":"light","classList":["theme-light"],"dataset":{"data-demo-palette":"sunrise"}},{"value":"default-dark","attributeValue":"dark","classList":["theme-dark"],"dataset":{"data-demo-palette":"default"}},{"value":"forest-dark","attributeValue":"dark","classList":["theme-dark"],"dataset":{"data-demo-palette":"forest"}}]}'
    ></mpr-footer>
  </body>
</html>
